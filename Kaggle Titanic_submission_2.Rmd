---
title: "Kaggle_Titanic_submission_2"
author: "JN"
date: "23/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#### Score (**Top 27% 0.77990**)

## Table of Contents 

[Loading relevant packages](#step1)

[Reading in the dataset](#step2)

[Cleaning up the data](#step3)

[Exploratory Data Analysis (EDA)](#step4)

[Building Models](#step5)

[Predicting survival on the Titanic](#step6)

## Loading relevant packages {#step1}

```{r packages}
library(ggplot2)
library(dplyr)
library(tidyr)
library(reshape2)
library(randomForest)
```

## Reading in the dataset {#step2}

```{r datasets}
Titanic.train <- read.csv("datasets/train.csv", stringsAsFactors = FALSE)
Titanic.test <- read.csv("datasets/test.csv", stringsAsFactors = FALSE)
Titanic.full <- bind_rows(Titanic.train, Titanic.test) # `bind_rows` returns the same type as the first input
```

## Cleaning up the data {#step3}

**Predictive variables**

* `PssengerId`: a passenger's ID

* `Pclass`: passenger Class (1 = 1st; 2 = 2nd; 3 = 3rd)

* `Name`: name of a passenger 

* `Sex`: sex of a passenger

* `Age`: age of a passenger

* `Sibsp`: number of siblings/spouses aboard of a passenger

* `Parch`: number of parents/children Aboard of a passenger

* `Ticket`: ticket number of a passenger

* `Fare`: passenger fare

* `Cabin`: cabin number

* `Embarked`: port of embarkation (C = Cherbourg; Q = Queenstown; S = Southampton)

**Response variable**

* `Survival`: a passenger 

###  1. Get a glimpse of the data
```{r cleanup.1}
glimpse(Titanic.full)
```

### 2. Check missing values

#### `Age` has 263 missing values.

#### `Fare` has 1 missing values.

#### `Cabin` has 1014 missing values.

#### `Embarked` has 2 missing values.
```{r cleanup.2}
table(is.na(Titanic.full)) # 682 NAs
colSums(is.na(Titanic.full)) # NA counts for each column 

colSums(Titanic.full == "") # NULL counts for each column 
```

### 3. Dealing with missing values

#### `Embarked` has 2 missing values.
```{r cleanup.3_embarked}
table(Titanic.full$Embarked) # Most common is `S`
Titanic.full$Embarked[Titanic.full$Embarked == ""] <- "S"
```

#### `Fare` has 1 missing values.
```{r cleanup.3_fare}
Titanic.full[is.na(Titanic.full$Fare), ] # find out the detail info of the missing fare value

Titanic.full %>%
  select(Pclass, Fare) %>%
  group_by(Pclass) %>%
  summarise(median_fare = median(Fare, na.rm = TRUE)) # `Fare` is related to `Pclass`

Titanic.full$Fare[Titanic.full$PassengerId == 1044] <- 8.05 # fill the median fare of 'Pclass` 3
```

#### `Age` has 263 missing values.

Look at the `Name` variable, there are different titles that may have relationships with age. 
```{r cleanup.3_age}
# create a new column named `Title`
Titanic.full$Title <- gsub('(.*, )|(\\..*)', '', Titanic.full$Name)

# count different titles 
table(Titanic.full$Title)

# median age of different titles
Titanic.full %>%
  select(Title, Age) %>%
  group_by(Title) %>%
  summarise(median_Age = round(median(Age, na.rm = TRUE), 2))

# Check the total missing values of age by titles
Titanic.full %>%
  select(Title, Age) %>%
  filter(is.na(Age)) %>%
  group_by(Title) %>%
  count()

# fill median ages by different titles for age missing values
Titanic.full[Titanic.full$Title == "Dr" & is.na(Titanic.full$Age), c("Age")] <- 49
Titanic.full[Titanic.full$Title == "Master" & is.na(Titanic.full$Age), c("Age")] <- 4
Titanic.full[Titanic.full$Title == "Miss" & is.na(Titanic.full$Age), c("Age")] <- 22
Titanic.full[Titanic.full$Title == "Mr" & is.na(Titanic.full$Age), c("Age")] <- 29
Titanic.full[Titanic.full$Title == "Mrs" & is.na(Titanic.full$Age), c("Age")] <- 35.5
Titanic.full[Titanic.full$Title == "Ms" & is.na(Titanic.full$Age), c("Age")] <- 28

# Check 
Titanic.full %>% filter(is.na(Age)) %>% count()

# Now, we do not have any missing values for `Age`.
```

#### `Cabin` has 1041 missing values.

Whether known a passenger's cabin is related to the response variable `Survived`. 
```{r cleanup.3_cabin}
# add a new column of Surname
Titanic.full$Surname <- gsub("([A-Za-z]+).*", "\\1", Titanic.full$Name)

# Look at `Cabin` details
Titanic.full_cabin <- Titanic.full %>%
  select(Surname, Title, SibSp, Parch, Cabin) %>%
  filter(Cabin != "") %>%
  arrange(Surname)
head(Titanic.full_cabin, 9)

# Check whether cabin/no cabin affect the survival result
Titanic.full$CabinLevel <- ifelse(Titanic.full$Cabin == "", 0, 1)

Titanic.full[1:891, ] %>%
  ggplot(aes(x = factor(CabinLevel), fill = factor(Survived))) +
  geom_bar(position = "fill") +
  ggtitle("The Relationship between Cabin/No Cabin and Survival") +
  ylab("Frequency") +
  xlab("Cabin (1) / No Cabin (0)") +
  scale_fill_discrete(name = "Survived") 
```

### 4. Factor the categorical variables
```{r cleanup.3}
Titanic.full$Survived <- as.factor(Titanic.full$Survived)
Titanic.full$Sex <- as.factor(Titanic.full$Sex)
Titanic.full$Pclass <- as.factor(Titanic.full$Pclass)
Titanic.full$Embarked <- as.factor(Titanic.full$Embarked)
Titanic.full$Title <- as.factor(Titanic.full$Title)
Titanic.full$CabinLevel <- as.factor(Titanic.full$CabinLevel)

str(Titanic.full)
```

## Exploratory Data Analysis (EDA) {#step4}

```{r EDA}
Titanic.full[1:891,] %>%
  group_by(Survived, Sex) %>%
  count() %>%
  pivot_wider(
    names_from = Survived,
    values_from = n,
  )

ggplot(Titanic.full[1:891,], aes(x = Sex, fill = Survived)) +
         geom_bar(position = "fill") +
         ggtitle("The Relationship between Sex and Survival") +
         ylab("Frequency")

Titanic.full[1:891,] %>%
  group_by(Survived, Pclass) %>%
  count() %>%
    pivot_wider(
    names_from = Survived,
    values_from = n,
  )

ggplot(Titanic.full[1:891,], aes(x = Pclass, fill = Survived)) +
         geom_bar(position = "fill") +
         ggtitle("The Relationship between Pclass and Survival") +
         ylab("Frequency")

ggplot(Titanic.full[1:891,], aes(x = Pclass, fill = Survived)) +
         geom_bar(position = "fill") +
         facet_wrap(~ Sex) +
         ggtitle("The Relationship between Pclass and Survival by Gender") +
         ylab("Frequency")

Titanic.full[1:891,] %>%
  group_by(Survived, Embarked) %>%
  count() %>%
    pivot_wider(
    names_from = Survived,
    values_from = n,
  )

ggplot(Titanic.full[1:891,], aes(x = Embarked, fill = Survived)) +
         geom_bar(position = "fill") +
         ggtitle("The Relationship between Embarked and Survival") +
         ylab("Frequency")
 
ggplot(Titanic.full[1:891,], aes(x = Embarked, fill = Survived)) +
         geom_bar(position = "fill") +
         facet_wrap(~ Sex) +
         ggtitle("The Relationship between Embarked and Survival by Gender") +
         ylab("Frequency")
 
ggplot(Titanic.full[1:891,], aes(x = Age, fill = Survived)) +
         geom_histogram() +
         ggtitle("The Relationship between Age and Survival")

ggplot(Titanic.full[1:891,], aes(x = Parch, fill = Survived)) +
         geom_bar(binwidth =1, position = "fill") +
         ggtitle("The Relationship between Parch and Survival") +
         ylab("Frequency")

ggplot(Titanic.full[1:891,], aes(x = SibSp, fill = Survived)) +
         geom_bar(binwidth =1, position = "fill") +
         ggtitle("The Relationship between Sibsp and Survival") +
         ylab("Frequency")

ggplot(Titanic.full[1:891,], aes(x = Fare, fill = Survived)) +
         geom_histogram(position = "fill") +
         ggtitle("The Relationship between Fare and Survival") +
         ylab("Frequency")

ggplot(Titanic.full[1:891,], aes(x = Title, fill = Survived)) +
         geom_bar(position = "fill") +
         ggtitle("The Relationship between Title and Survival") +
         ylab("Frequency")

```

Based on what has been shown above, **I will choose `Pclass`, `Sex`, `Age`, `SibSp`, `Parch`, `Fare`, `Embarked`, `Title` and `CabinLevel` as the predictive variables in my analysis.**

## Building models {#step5}
```{r model_rf}
set.seed(2)
model_rf <- randomForest(Survived ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked + Title + CabinLevel, ntree = 1000, data = Titanic.full[1:891, ], importance = TRUE)

importance(model_rf)
varImpPlot(model_rf)

model_rf2 <- randomForest(Survived ~ Pclass + Sex + Age + SibSp + Fare + Title + CabinLevel, ntree = 1000, data = Titanic.full[1:891, ], importance = TRUE)

importance(model_rf2)
varImpPlot(model_rf2)
```

## Predicting survival on the Titanic {#step6}
```{r randomForest}
# randomForest
predict <- predict(model_rf, newdata = Titanic.full[892:1309,])

pred.rf <- data.frame(PassengerId = Titanic.full[892:1309,]$PassengerId, Survived = predict)

write.csv(pred.rf, file = "Titanic_randomForest_3.csv", row.names = F)

# refined rf
predict <- predict(model_rf2, newdata = Titanic.full[892:1309,])

pred.rf <- data.frame(PassengerId = Titanic.full[892:1309,]$PassengerId, Survived = predict)

write.csv(pred.rf, file = "Titanic_randomForest_4.csv", row.names = F)

```





















